{% extends "layout.html" %}
{% block content %}
<h2>ğŸ‘¤ Perfil do Aluno â€” RA {{ ra }}</h2>

<div class="tabs">
  <button class="tab-btn active" data-aba="contato">Contato</button>
  <button class="tab-btn" data-aba="endereco">EndereÃ§o</button>
</div>

<div id="conteudo-aba" class="tab-content card"></div>

<div class="mt-16">
  <a class="botao" href="{{ url_for('home') }}">â¬…ï¸ Voltar Ã  lista</a>
</div>

<script>
const ra = "{{ ra }}";
let dados = {};

function sanitize(v) {
  if (v === null || v === undefined) return '';
  const s = String(v).trim();
  return (s.toLowerCase() === 'nan' || s.toLowerCase() === 'none') ? '' : s;
}

// ğŸ“… Formata data para padrÃ£o brasileiro
function formatarDataBR(dataISO) {
  if (!dataISO) return '-';
  const data = new Date(dataISO);
  return data.toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
}

window.addEventListener('DOMContentLoaded', async () => {
  const res = await fetch(`/api/aluno/${ra}/all`);
  dados = await res.json();
  abrirAba('contato');
});

document.addEventListener('click', e => {
  if (e.target.classList.contains('tab-btn')) {
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    abrirAba(e.target.dataset.aba);
  }
});

function abrirAba(tipo) {
  if (tipo === 'contato') render(tipo, dados.contato);
  else if (tipo === 'endereco') render(tipo, dados.endereco);
}

function render(tipo, d) {
  const c = document.getElementById('conteudo-aba');

  if (tipo === 'contato') {
    c.innerHTML = `
      <h3>ğŸ“ Contato</h3>
      <div class="grid-2">
        <div>
          <label>Email</label><input id="email" value="${sanitize(d.email)}">
          <label>Celular</label><input id="celular" value="${sanitize(d.celular)}">
          <label>Telefone Fixo</label><input id="telefone_fixo" value="${sanitize(d.telefone_fixo)}">
          <label>LinkedIn</label><input id="linkedin" value="${sanitize(d.linkedin)}">
        </div>
        <div>
          <fieldset><legend>EmergÃªncia 1</legend>
            <label>Nome</label><input id="nome_emergencia_1" value="${sanitize(d.nome_emergencia_1)}">
            <label>Telefone</label><input id="tel_emergencia_1" value="${sanitize(d.tel_emergencia_1)}">
            <label>Parentesco</label><input id="parentesco_emergencia_1" value="${sanitize(d.parentesco_emergencia_1)}">
          </fieldset>
          <fieldset><legend>EmergÃªncia 2</legend>
            <label>Nome</label><input id="nome_emergencia_2" value="${sanitize(d.nome_emergencia_2)}">
            <label>Telefone</label><input id="tel_emergencia_2" value="${sanitize(d.tel_emergencia_2)}">
            <label>Parentesco</label><input id="parentesco_emergencia_2" value="${sanitize(d.parentesco_emergencia_2)}">
          </fieldset>
        </div>
      </div>
      <div class="actions">
        <button class="salvar" onclick="salvar('contato')">ğŸ’¾ Salvar</button>
      </div>
      <p class="muted">Ãšltima modificaÃ§Ã£o: 
        <b>${formatarDataBR(d.ValidFrom)}</b> 
        por <b>${sanitize(d.last_modified_by)}</b>
      </p>
    `;
  } else if (tipo === 'endereco') {
    c.innerHTML = `
      <h3>ğŸ  EndereÃ§o</h3>
      <div class="grid-2">
        <div>
          <label>Rua</label><input id="rua" value="${sanitize(d.rua)}">
          <label>NÃºmero</label><input id="numero" value="${sanitize(d.numero)}">
          <label>Complemento</label><input id="complemento" value="${sanitize(d.complemento)}">
        </div>
        <div>
          <label>CEP</label><input id="cep" value="${sanitize(d.cep)}" placeholder="00000-000">
          <label>Bairro</label><input id="bairro" value="${sanitize(d.bairro)}">
        </div>
      </div>
      <div class="actions">
        <button class="salvar" onclick="salvar('endereco')">ğŸ’¾ Salvar</button>
      </div>
      <p class="muted">Ãšltima modificaÃ§Ã£o: 
        <b>${formatarDataBR(d.ValidFrom)}</b> 
        por <b>${sanitize(d.last_modified_by)}</b>
      </p>
    `;
  }
}

async function salvar(tipo) {
  const inputs = document.querySelectorAll('#conteudo-aba input');
  const payload = {};
  inputs.forEach(i => payload[i.id] = i.value);

  const res = await fetch(`/api/aluno/${ra}/${tipo}/update`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  alert(json.msg || 'Atualizado!');
}
</script>
{% endblock %}

{% extends "layout.html" %}
{% block content %}
<h2>ğŸ“‹ Lista de Alunos</h2>
<p>Busque por RA ou nome â€” ou veja os 100 primeiros registros.</p>

<div style="margin-bottom: 15px;">
  <input type="text" id="campo-busca" placeholder="Digite para buscar..."
         style="width:50%;padding:8px;border-radius:6px;border:1px solid #ccc;">
  <span id="status-busca" style="margin-left:10px;color:#555;font-style:italic;"></span>
</div>

<table id="tabela-ra">
  <thead>
    <tr>
      <th>RA</th>
      <th>Nome</th>
      <th>AÃ§Ãµes</th>
    </tr>
  </thead>
  <tbody id="corpo-tabela">
    {% for c in alunos %}
    <tr id="row-{{ c.ra }}">
      <td>{{ c.ra }}</td>
      <td>{{ c.nome or '-' }}</td>
      <td><a class="botao" href="{{ url_for('aluno_detalhe', ra=c.ra) }}">ğŸ‘ï¸ Ver perfil</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
let debounceTimer;
const campoBusca = document.getElementById('campo-busca');
const statusBusca = document.getElementById('status-busca');

campoBusca.addEventListener('input', function(){
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => buscar(this.value.trim()), 400);
});

async function buscar(termo) {
  statusBusca.textContent = 'â³ Buscando...';
  const res = await fetch(`/buscar?q=${encodeURIComponent(termo)}`, {
    headers: { 'Accept':'application/json', 'X-Requested-With':'XMLHttpRequest' },
    cache: 'no-store'
  });

  if (res.status === 401) {
    statusBusca.textContent = 'âš ï¸ SessÃ£o expirada. Redirecionando...';
    setTimeout(() => window.location.href = '/login', 1200);
    return;
  }

  const ctype = res.headers.get('content-type') || '';
  if (!ctype.includes('application/json')) {
    statusBusca.textContent = 'âŒ Erro inesperado (resposta nÃ£o-JSON).';
    console.error(await res.text());
    return;
  }

  const alunos = await res.json();
  const tbody = document.getElementById('corpo-tabela');
  tbody.innerHTML = '';
  alunos.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${a.ra}</td>
      <td>${a.nome || '-'}</td>
      <td><a class="botao" href="/aluno/${a.ra}">ğŸ‘ï¸ Ver perfil</a></td>`;
    tbody.appendChild(tr);
  });

  statusBusca.textContent =
    alunos.length === 0 ? 'âš ï¸ Nenhum resultado'
    : alunos.length === 1 ? 'âœ… 1 registro'
    : `âœ… ${alunos.length} registros`;
}
</script>
{% endblock %}

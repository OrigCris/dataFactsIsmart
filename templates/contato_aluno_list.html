<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Contatos de Alunos</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f6f6; padding: 30px; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #eee; }
    a.botao { text-decoration: none; color: #0078d7; font-weight: bold; }
    a.botao:hover { color: #004f9e; }
    #modal {
      display: none;
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center; align-items: center;
    }
    #modal-content {
      background: white; padding: 20px; border-radius: 8px;
      width: 400px;
    }
    #modal input { width: 98%; padding: 8px; margin-bottom: 10px; }
    #modal button { padding: 8px 16px; cursor: pointer; }
    #mensagem { margin-top: 10px; font-style: italic; color: #666; }
    #loading {
      display: none;
      font-size: 14px;
      color: #0078d7;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<h1>üìã Contatos de Alunos</h1>
<a href="/" class="botao">‚¨Ö Voltar</a>
<!-- <a href="/contato_aluno/novo" class="botao">‚ûï Novo Contato</a> -->
<br><br>

<input type="text" id="campo-busca" placeholder="üîç Buscar RA, email ou celular..." style="width:50%; padding:8px; margin-bottom:15px;">
<div id="loading">‚è≥ Buscando...</div>

<table id="tabela-contatos">
  <thead>
    <tr>
      <th>ID</th><th>RA</th><th>Email Ismart</th><th>Email Pessoal</th><th>Celular</th><th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody id="corpo-tabela">
    {% for c in contatos %}
    <tr id="row-{{ c.id_contato_aluno }}">
      <td>{{ c.id_contato_aluno }}</td>
      <td>{{ c.ra }}</td>
      <td>{{ c.email_ismart }}</td>
      <td>{{ c.email_pessoal }}</td>
      <td>{{ c.celular }}</td>
      <td>
        <a href="#" class="botao" onclick="abrirModal({{ c.id_contato_aluno }}, '{{ c.ra }}', '{{ c.email_ismart }}', '{{ c.email_pessoal }}', '{{ c.celular }}')">Editar</a> |
        <!-- <a href="/contato_aluno/deletar/{{ c.id_contato_aluno }}" class="botao" onclick="return confirm('Tem certeza que deseja excluir?')">Excluir</a> -->
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<p id="mensagem"></p>

<!-- Modal -->
<div id="modal">
  <div id="modal-content">
    <h3>Editar Contato</h3>
    <form id="form-editar">
      <input type="hidden" id="id_contato_aluno">
      <label>RA:</label>
      <input type="text" id="ra"><br>
      <label>Email Ismart:</label>
      <input type="email" id="email_ismart"><br>
      <label>Email Pessoal:</label>
      <input type="email" id="email_pessoal"><br>
      <label>Celular:</label>
      <input type="text" id="celular"><br>
      <button type="button" onclick="salvarEdicao()">üíæ Salvar</button>
      <button type="button" onclick="fecharModal()">‚ùå Fechar</button>
    </form>
  </div>
</div>

<script>
function abrirModal(id_contato_aluno, ra, email_ismart, email_pessoal, celular) {
  document.getElementById('id_contato_aluno').value = id_contato_aluno;
  document.getElementById('ra').value = ra;
  document.getElementById('email_ismart').value = email_ismart;
  document.getElementById('email_pessoal').value = email_pessoal;
  document.getElementById('celular').value = celular;
  document.getElementById('modal').style.display = 'flex';
}

function fecharModal() {
  document.getElementById('modal').style.display = 'none';
}

async function salvarEdicao() {
  const id = document.getElementById('id_contato_aluno').value;
  const data = {
    ra: document.getElementById('ra').value,
    email_ismart: document.getElementById('email_ismart').value,
    email_pessoal: document.getElementById('email_pessoal').value,
    celular: document.getElementById('celular').value
  };

  // üîß Aqui usamos o "id" que pegamos acima
  const res = await fetch(`/contato_aluno/update_ajax/${id}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });

  const json = await res.json();
  if (json.status === 'ok') {
    // Atualiza a linha na tabela sem recarregar
    const row = document.getElementById(`row-${id}`);
    row.children[1].innerText = data.ra;
    row.children[2].innerText = data.email_ismart;
    row.children[3].innerText = data.email_pessoal;
    row.children[4].innerText = data.celular;
    fecharModal();
  } else {
    alert('Erro ao salvar altera√ß√£o');
  }
}

// --- üîç Busca din√¢mica no servidor (com debounce) ---
let debounceTimer;
document.getElementById('campo-busca').addEventListener('input', function() {
  clearTimeout(debounceTimer);
  const termo = this.value.trim();
  debounceTimer = setTimeout(() => buscarServidor(termo), 300);
});

async function buscarServidor(termo) {
  const loading = document.getElementById('loading');
  const mensagem = document.getElementById('mensagem');
  const corpo = document.getElementById('corpo-tabela');
  
  loading.style.display = 'block';
  mensagem.innerText = '';
  corpo.innerHTML = '';

  try {
    const res = await fetch(`/contato_aluno/search?q=${encodeURIComponent(termo)}`);
    const contatos = await res.json();

    if (contatos.length === 0) {
      mensagem.innerText = 'Nenhum resultado encontrado.';
    } else {
      contatos.forEach(c => {
        const row = document.createElement('tr');
        row.id = `row-${c.id_contato_aluno}`;
        row.innerHTML = `
          <td>${c.id_contato_aluno}</td>
          <td>${c.ra}</td>
          <td>${c.email_ismart}</td>
          <td>${c.email_pessoal}</td>
          <td>${c.celular}</td>
          <td><a href="#" class="botao" onclick="abrirModal(${c.id_contato_aluno}, '${c.ra}', '${c.email_ismart}', '${c.email_pessoal}', '${c.celular}')">Editar</a></td>
        `;
        corpo.appendChild(row);
      });
    }
  } catch (error) {
    mensagem.innerText = 'Erro ao buscar dados.';
  } finally {
    loading.style.display = 'none';
  }
}
</script>

</body>
</html>

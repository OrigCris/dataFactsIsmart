<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Contatos de Alunos</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f6f6; padding: 30px; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #eee; }
    a.botao { text-decoration: none; color: #0078d7; font-weight: bold; }
    a.botao:hover { color: #004f9e; }
    #modal, #modal-novo {
      display: none;
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center; align-items: center;
      overflow: auto;
      z-index: 1000;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 8px;
      width: 500px; max-height: 90%; overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    input { width: 98%; padding: 6px; margin-bottom: 8px; }
    button { padding: 8px 16px; margin-top: 5px; cursor: pointer; }
    #loading { display: none; color: #0078d7; margin-bottom: 8px; }
    #mensagem { color: #555; font-style: italic; margin-top: 10px; }
  </style>
</head>
<body>

<h1>üìã Contatos de Alunos</h1>
<a href="/" class="botao">‚¨Ö Voltar</a>
<a href="#" class="botao" onclick="abrirModalNovo()">‚ûï Novo Contato</a>
<br><br>

<input type="text" id="campo-busca" placeholder="üîç Buscar RA, e-mail ou nome..." style="width:50%; padding:8px; margin-bottom:10px;">
<div id="loading">‚è≥ Buscando...</div>

<table id="tabela-contatos">
  <thead>
    <tr>
      <th>ID</th>
      <th>RA</th>
      <th>Email Ismart</th>
      <th>Email Pessoal</th>
      <th>Celular</th>
      <th>Modificado por</th>
      <th>√öltima modifica√ß√£o</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody id="corpo-tabela">
    {% for c in contatos %}
    <tr id="row-{{ c.id_contato_aluno }}">
      <td>{{ c.id_contato_aluno }}</td>
      <td>{{ c.ra }}</td>
      <td>{{ c.email_ismart }}</td>
      <td>{{ c.email_pessoal }}</td>
      <td>{{ c.celular }}</td>
      <td>{{ c.last_modified_by or '-' }}</td>
      <td>{{ c.ValidFrom }}</td>
      <td>
        <a href="#" class="botao" 
           data-contato='{{ c | tojson | safe }}'
           onclick="abrirModal(this)">Editar</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<p id="mensagem"></p>

<!-- Modal Editar -->
<div id="modal">
  <div class="modal-content">
    <h3>Editar Contato</h3>
    <form id="form-editar">
      <input type="hidden" id="id_contato_aluno">
      <label>RA:</label> <input type="text" id="ra"><br>
      <label>Email Ismart:</label> <input type="email" id="email_ismart"><br>
      <label>Email Pessoal:</label> <input type="email" id="email_pessoal"><br>
      <label>Celular:</label> <input type="text" id="celular"><br>
      <label>Telefone Fixo:</label> <input type="text" id="telefone_fixo"><br>
      <label>LinkedIn:</label> <input type="text" id="linkedin"><br>
      <label>Facebook:</label> <input type="text" id="facebook"><br>
      <label>Instagram:</label> <input type="text" id="instagram"><br>
      <h4>Contato de Emerg√™ncia 1</h4>
      <label>Nome:</label> <input type="text" id="nome_emergencia1"><br>
      <label>Telefone:</label> <input type="text" id="tel_emergencia1"><br>
      <label>Parentesco:</label> <input type="text" id="parentesco_emergencia1"><br>
      <h4>Contato de Emerg√™ncia 2</h4>
      <label>Nome:</label> <input type="text" id="nome_emergencia2"><br>
      <label>Telefone:</label> <input type="text" id="tel_emergencia2"><br>
      <label>Parentesco:</label> <input type="text" id="parentesco_emergencia2"><br>
      <button type="button" onclick="salvarEdicao()">üíæ Salvar</button>
      <button type="button" onclick="fecharModal()">‚ùå Fechar</button>
    </form>
  </div>
</div>

<!-- Modal Novo Registro (Completo) -->
<div id="modal-novo">
  <div class="modal-content">
    <h3>Novo Contato</h3>
    <form id="form-novo">
      <label>RA:</label> <input type="text" id="novo_ra"><br>
      <label>Email Ismart:</label> <input type="email" id="novo_email_ismart"><br>
      <label>Email Pessoal:</label> <input type="email" id="novo_email_pessoal"><br>
      <label>Celular:</label> <input type="text" id="novo_celular"><br>
      <label>Telefone Fixo:</label> <input type="text" id="novo_telefone_fixo"><br>
      <label>LinkedIn:</label> <input type="text" id="novo_linkedin"><br>
      <label>Facebook:</label> <input type="text" id="novo_facebook"><br>
      <label>Instagram:</label> <input type="text" id="novo_instagram"><br>
      <h4>Contato de Emerg√™ncia 1</h4>
      <label>Nome:</label> <input type="text" id="novo_nome_emergencia1"><br>
      <label>Telefone:</label> <input type="text" id="novo_tel_emergencia1"><br>
      <label>Parentesco:</label> <input type="text" id="novo_parentesco_emergencia1"><br>
      <h4>Contato de Emerg√™ncia 2</h4>
      <label>Nome:</label> <input type="text" id="novo_nome_emergencia2"><br>
      <label>Telefone:</label> <input type="text" id="novo_tel_emergencia2"><br>
      <label>Parentesco:</label> <input type="text" id="novo_parentesco_emergencia2"><br>
      <button type="button" onclick="salvarNovo()">üíæ Salvar</button>
      <button type="button" onclick="fecharModalNovo()">‚ùå Fechar</button>
    </form>
  </div>
</div>

<script>
// --- Abrir/Fechar Modais ---
function abrirModal(el) {
  const contato = typeof el === 'object' && el.dataset 
      ? JSON.parse(el.dataset.contato)
      : el;
  for (const campo in contato) {
    const input = document.getElementById(campo);
    if (input) input.value = contato[campo] || '';
  }
  document.getElementById('modal').style.display = 'flex';
}
function fecharModal() {
  document.getElementById('modal').style.display = 'none';
}
function abrirModalNovo() {
  document.getElementById('modal-novo').style.display = 'flex';
}
function fecharModalNovo() {
  document.getElementById('modal-novo').style.display = 'none';
}

// --- Salvar Edi√ß√£o ---
async function salvarEdicao() {
  const id = document.getElementById('id_contato_aluno').value;
  const data = {};
  document.querySelectorAll('#form-editar input').forEach(el => {
    data[el.id] = el.value;
  });
  const res = await fetch(`/contato_aluno/update_ajax/${id}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  const json = await res.json();
  if (json.status === 'ok') {
    alert('‚úÖ Contato atualizado com sucesso!');
    setTimeout(() => window.location.reload(), 500);
  } else {
    alert('‚ùå Erro ao salvar altera√ß√£o.');
  }
}

// --- Salvar Novo ---
async function salvarNovo() {
  const campos = [
    'ra','email_ismart','email_pessoal','celular','telefone_fixo',
    'linkedin','facebook','instagram','nome_emergencia1','tel_emergencia1',
    'parentesco_emergencia1','nome_emergencia2','tel_emergencia2','parentesco_emergencia2'
  ];
  const data = {};
  campos.forEach(c => {
    const el = document.getElementById(`novo_${c}`);
    data[c] = el ? el.value : null;
  });
  const res = await fetch('/contato_aluno/add_ajax', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  const json = await res.json();
  if (json.status === 'ok') {
    alert('‚úÖ Contato adicionado com sucesso!');
    setTimeout(() => window.location.reload(), 500);
  } else {
    alert('‚ùå Erro ao adicionar contato.');
  }
}

// --- üîç Busca din√¢mica ---
let debounceTimer;
document.getElementById('campo-busca').addEventListener('input', function() {
  clearTimeout(debounceTimer);
  const termo = this.value.trim();
  debounceTimer = setTimeout(() => buscarServidor(termo), 300);
});
async function buscarServidor(termo) {
  const corpo = document.getElementById('corpo-tabela');
  const loading = document.getElementById('loading');
  const msg = document.getElementById('mensagem');
  loading.style.display = 'block';
  msg.innerText = '';
  corpo.innerHTML = '';
  try {
    const res = await fetch(`/contato_aluno/search?q=${encodeURIComponent(termo)}`);
    const contatos = await res.json();
    if (contatos.length === 0) {
      msg.innerText = 'Nenhum resultado encontrado.';
    } else {
      contatos.forEach(c => {
        const row = document.createElement('tr');
        row.id = `row-${c.id_contato_aluno}`;
        row.innerHTML = `
          <td>${c.id_contato_aluno}</td>
          <td>${c.ra}</td>
          <td>${c.email_ismart}</td>
          <td>${c.email_pessoal}</td>
          <td>${c.celular}</td>
          <td>${c.last_modified_by ?? '-'}</td>
          <td>${c.ValidFrom}</td>
          <td><a href="#" class="botao" onclick='abrirModal(${JSON.stringify(c)})'>Editar</a></td>
        `;
        corpo.appendChild(row);
      });
    }
  } catch (err) {
    msg.innerText = 'Erro ao buscar dados.';
  } finally {
    loading.style.display = 'none';
  }
}
</script>
</body>
</html>
